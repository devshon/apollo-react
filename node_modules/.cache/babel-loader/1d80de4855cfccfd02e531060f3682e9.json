{"ast":null,"code":"\"use strict\";\n\nvar __assign = this && this.__assign || Object.assign || function (t) {\n  for (var s, i = 1, n = arguments.length; i < n; i++) {\n    s = arguments[i];\n\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\n  }\n\n  return t;\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar graphql_1 = require(\"graphql\");\n\nvar CacheScope;\n\n(function (CacheScope) {\n  CacheScope[\"Public\"] = \"PUBLIC\";\n  CacheScope[\"Private\"] = \"PRIVATE\";\n})(CacheScope = exports.CacheScope || (exports.CacheScope = {}));\n\nvar CacheControlExtension =\n/** @class */\nfunction () {\n  function CacheControlExtension(options) {\n    if (options === void 0) {\n      options = {};\n    }\n\n    this.hints = new Map();\n    this.defaultMaxAge = options.defaultMaxAge || 0;\n  }\n\n  CacheControlExtension.prototype.willResolveField = function (_source, _args, _context, info) {\n    var _this = this;\n\n    var hint = {}; // If this field's resolver returns an object or interface, look for hints\n    // on that return type.\n\n    var targetType = graphql_1.getNamedType(info.returnType);\n\n    if (targetType instanceof graphql_1.GraphQLObjectType || targetType instanceof graphql_1.GraphQLInterfaceType) {\n      if (targetType.astNode) {\n        hint = mergeHints(hint, cacheHintFromDirectives(targetType.astNode.directives));\n      }\n    } // If this field is a field on an object, look for hints on the field\n    // itself, taking precedence over previously calculated hints.\n\n\n    var parentType = info.parentType;\n\n    if (parentType instanceof graphql_1.GraphQLObjectType) {\n      var fieldDef = parentType.getFields()[info.fieldName];\n\n      if (fieldDef.astNode) {\n        hint = mergeHints(hint, cacheHintFromDirectives(fieldDef.astNode.directives));\n      }\n    } // If this resolver returns an object and we haven't seen an explicit maxAge\n    // hint, set the maxAge to 0 (uncached) or the default if specified in the\n    // constructor.  (Non-object fields by default are assumed to inherit their\n    // cacheability from their parents.)\n\n\n    if (targetType instanceof graphql_1.GraphQLObjectType && hint.maxAge === undefined) {\n      hint.maxAge = this.defaultMaxAge;\n    }\n\n    if (hint.maxAge !== undefined || hint.scope !== undefined) {\n      this.addHint(info.path, hint);\n    }\n\n    info.cacheControl = {\n      setCacheHint: function (hint) {\n        _this.addHint(info.path, hint);\n      },\n      cacheHint: hint\n    };\n  };\n\n  CacheControlExtension.prototype.addHint = function (path, hint) {\n    var existingCacheHint = this.hints.get(path);\n\n    if (existingCacheHint) {\n      this.hints.set(path, mergeHints(existingCacheHint, hint));\n    } else {\n      this.hints.set(path, hint);\n    }\n  };\n\n  CacheControlExtension.prototype.format = function () {\n    return ['cacheControl', {\n      version: 1,\n      hints: Array.from(this.hints).map(function (_a) {\n        var path = _a[0],\n            hint = _a[1];\n        return __assign({\n          path: graphql_1.responsePathAsArray(path)\n        }, hint);\n      })\n    }];\n  };\n\n  return CacheControlExtension;\n}();\n\nexports.CacheControlExtension = CacheControlExtension;\n\nfunction cacheHintFromDirectives(directives) {\n  if (!directives) return undefined;\n  var cacheControlDirective = directives.find(function (directive) {\n    return directive.name.value === 'cacheControl';\n  });\n  if (!cacheControlDirective) return undefined;\n  if (!cacheControlDirective.arguments) return undefined;\n  var maxAgeArgument = cacheControlDirective.arguments.find(function (argument) {\n    return argument.name.value === 'maxAge';\n  });\n  var scopeArgument = cacheControlDirective.arguments.find(function (argument) {\n    return argument.name.value === 'scope';\n  }); // TODO: Add proper typechecking of arguments\n\n  return {\n    maxAge: maxAgeArgument && maxAgeArgument.value && maxAgeArgument.value.kind === 'IntValue' ? parseInt(maxAgeArgument.value.value) : undefined,\n    scope: scopeArgument && scopeArgument.value && scopeArgument.value.kind === 'EnumValue' ? scopeArgument.value.value : undefined\n  };\n}\n\nfunction mergeHints(hint, otherHint) {\n  if (!otherHint) return hint;\n  return {\n    maxAge: otherHint.maxAge !== undefined ? otherHint.maxAge : hint.maxAge,\n    scope: otherHint.scope || hint.scope\n  };\n}","map":{"version":3,"sources":["../src/index.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __assign = (this && this.__assign) || Object.assign || function(t) {\n    for (var s, i = 1, n = arguments.length; i < n; i++) {\n        s = arguments[i];\n        for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))\n            t[p] = s[p];\n    }\n    return t;\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar graphql_1 = require(\"graphql\");\nvar CacheScope;\n(function (CacheScope) {\n    CacheScope[\"Public\"] = \"PUBLIC\";\n    CacheScope[\"Private\"] = \"PRIVATE\";\n})(CacheScope = exports.CacheScope || (exports.CacheScope = {}));\nvar CacheControlExtension = /** @class */ (function () {\n    function CacheControlExtension(options) {\n        if (options === void 0) { options = {}; }\n        this.hints = new Map();\n        this.defaultMaxAge = options.defaultMaxAge || 0;\n    }\n    CacheControlExtension.prototype.willResolveField = function (_source, _args, _context, info) {\n        var _this = this;\n        var hint = {};\n        // If this field's resolver returns an object or interface, look for hints\n        // on that return type.\n        var targetType = graphql_1.getNamedType(info.returnType);\n        if (targetType instanceof graphql_1.GraphQLObjectType\n            || targetType instanceof graphql_1.GraphQLInterfaceType) {\n            if (targetType.astNode) {\n                hint = mergeHints(hint, cacheHintFromDirectives(targetType.astNode.directives));\n            }\n        }\n        // If this field is a field on an object, look for hints on the field\n        // itself, taking precedence over previously calculated hints.\n        var parentType = info.parentType;\n        if (parentType instanceof graphql_1.GraphQLObjectType) {\n            var fieldDef = parentType.getFields()[info.fieldName];\n            if (fieldDef.astNode) {\n                hint = mergeHints(hint, cacheHintFromDirectives(fieldDef.astNode.directives));\n            }\n        }\n        // If this resolver returns an object and we haven't seen an explicit maxAge\n        // hint, set the maxAge to 0 (uncached) or the default if specified in the\n        // constructor.  (Non-object fields by default are assumed to inherit their\n        // cacheability from their parents.)\n        if (targetType instanceof graphql_1.GraphQLObjectType && hint.maxAge === undefined) {\n            hint.maxAge = this.defaultMaxAge;\n        }\n        if (hint.maxAge !== undefined || hint.scope !== undefined) {\n            this.addHint(info.path, hint);\n        }\n        info.cacheControl = {\n            setCacheHint: function (hint) {\n                _this.addHint(info.path, hint);\n            },\n            cacheHint: hint\n        };\n    };\n    CacheControlExtension.prototype.addHint = function (path, hint) {\n        var existingCacheHint = this.hints.get(path);\n        if (existingCacheHint) {\n            this.hints.set(path, mergeHints(existingCacheHint, hint));\n        }\n        else {\n            this.hints.set(path, hint);\n        }\n    };\n    CacheControlExtension.prototype.format = function () {\n        return [\n            'cacheControl',\n            {\n                version: 1,\n                hints: Array.from(this.hints).map(function (_a) {\n                    var path = _a[0], hint = _a[1];\n                    return (__assign({ path: graphql_1.responsePathAsArray(path) }, hint));\n                })\n            }\n        ];\n    };\n    return CacheControlExtension;\n}());\nexports.CacheControlExtension = CacheControlExtension;\nfunction cacheHintFromDirectives(directives) {\n    if (!directives)\n        return undefined;\n    var cacheControlDirective = directives.find(function (directive) { return directive.name.value === 'cacheControl'; });\n    if (!cacheControlDirective)\n        return undefined;\n    if (!cacheControlDirective.arguments)\n        return undefined;\n    var maxAgeArgument = cacheControlDirective.arguments.find(function (argument) { return argument.name.value === 'maxAge'; });\n    var scopeArgument = cacheControlDirective.arguments.find(function (argument) { return argument.name.value === 'scope'; });\n    // TODO: Add proper typechecking of arguments\n    return {\n        maxAge: maxAgeArgument && maxAgeArgument.value && maxAgeArgument.value.kind === 'IntValue'\n            ? parseInt(maxAgeArgument.value.value)\n            : undefined,\n        scope: scopeArgument && scopeArgument.value && scopeArgument.value.kind === 'EnumValue'\n            ? scopeArgument.value.value\n            : undefined\n    };\n}\nfunction mergeHints(hint, otherHint) {\n    if (!otherHint)\n        return hint;\n    return {\n        maxAge: otherHint.maxAge !== undefined ? otherHint.maxAge : hint.maxAge,\n        scope: otherHint.scope || hint.scope\n    };\n}\n//# sourceMappingURL=index.js.map"]},"metadata":{},"sourceType":"script"}